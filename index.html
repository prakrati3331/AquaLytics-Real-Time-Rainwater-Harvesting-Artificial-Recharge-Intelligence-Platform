<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RWH AQUALYTICS</title>
  <style>
    body { font-family: Arial; text-align: center; margin: 20px; }
    input, select { padding: 8px; margin: 5px; width: 200px; }
    button { padding: 10px 20px; margin-top: 10px; cursor: pointer; }
    #response { margin-top: 20px; white-space: pre-wrap; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto; }
    #map { width: 100%; height: 400px; margin-top: 20px; border-radius: 10px; }
  </style>
</head>
<body>
  <h2>AQUALYTICS</h2>

  <h3>Manual Input or Use Map</h3>
  <div>
    <input type="text" id="district" placeholder="District" />
    <input type="text" id="state" placeholder="State" /><br/>
    <input type="number" id="roofArea" placeholder="Roof Area (mÂ²)" />
    <select id="roofType">
      <option value="CONCRETE">Concrete</option>
      <option value="GI_SHEET">GI Sheet</option>
      <option value="TILE">Tile</option>
      <option value="THATCHED">Thatched</option>
    </select><br/>
    <input type="number" id="dwellers" placeholder="Number of Dwellers" />
  </div>
  <button onclick="submitManual()">Check Feasibility</button>

  <h3>Map-based Location</h3>
  <button onclick="getLocation()">Get My Location</button>
  <div id="map"></div>

  <div id="response"></div>

  <script>
    let map;
    let marker;
    let geocoder;

    function initMap() {
      geocoder = new google.maps.Geocoder();
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 20.5937, lng: 78.9629 },
        zoom: 5
      });
    }

    // Manual input submit
    async function submitManual() {
      const district = document.getElementById("district").value;
      const state = document.getElementById("state").value;
      const roofArea = parseFloat(document.getElementById("roofArea").value);
      const roofType = document.getElementById("roofType").value;
      const dwellers = parseInt(document.getElementById("dwellers").value);

      if (!district || !state) {
        alert("Please enter district and state (or use 'Get My Location').");
        return;
      }

      const payload = { district, state, roofArea, roofType, dwellers };
      const responseDiv = document.getElementById("response");
      responseDiv.innerText = "Processing...";

      try {
        const res = await fetch("http://127.0.0.1:8000/process-location", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        responseDiv.innerText = JSON.stringify(data, null, 2);
      } catch (err) {
        responseDiv.innerText = "Error: " + err;
      }
    }

    // Map-based location
    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition, showError);
      } else {
        alert("Geolocation is not supported by this browser.");
      }
    }

    function showPosition(position) {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;

      map.setCenter({ lat, lng });
      map.setZoom(15);

      if (marker) marker.setMap(null);
      marker = new google.maps.Marker({
        position: { lat, lng },
        map: map,
        title: "You are here!"
      });

      // Reverse geocode to fill district/state automatically
      geocoder.geocode({ location: { lat, lng } }, (results, status) => {
        if (status === "OK" && results[0]) {
          let city = "", state = "";
          results[0].address_components.forEach(comp => {
            if (comp.types.includes("locality")) city = comp.long_name;
            if (comp.types.includes("administrative_area_level_1")) state = comp.long_name;
          });

          if (city) document.getElementById("district").value = city;
          if (state) document.getElementById("state").value = state;

          document.getElementById("response").innerText =
            `Location detected:\nLatitude: ${lat}, Longitude: ${lng}\nDistrict: ${city}\nState: ${state}`;
        }
      });
    }

    function showError(error) {
      switch(error.code) {
        case error.PERMISSION_DENIED:
          alert("User denied location access.");
          break;
        case error.POSITION_UNAVAILABLE:
          alert("Location unavailable.");
          break;
        case error.TIMEOUT:
          alert("Location request timed out.");
          break;
        default:
          alert("Unknown error.");
      }
    }
  </script>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCZNsn2uYkFtX0jPK4hZ8tdxQJ--Uapqdo&callback=initMap">
  </script>
</body>
</html>
